name: Update Download Count Badge

on:
  schedule:
    - cron: '0 0 * * *'  # Runs daily at midnight UTC
  workflow_dispatch:  # Allows manual triggering

jobs:
  update-badge:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to push changes
    steps:
    - uses: actions/checkout@v5

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.x'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests

    - name: Fetch download count and update README
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        import os
        import requests

        def get_total_downloads(repo):
            total_downloads = 0
            page = 1
            
            while True:
                url = f"https://api.github.com/repos/josdemmers/{repo}/releases?page={page}&per_page=100"
                headers = {"Authorization": f"token {os.environ['GITHUB_TOKEN']}"}
                response = requests.get(url, headers=headers)
                
                if response.status_code != 200:
                    print(f"Error fetching page {page}: {response.status_code}")
                    break
                    
                releases = response.json()
                
                if not releases:  # No more releases
                    break
                
                # Count downloads for this page
                for release in releases:
                    for asset in release.get('assets', []):
                        total_downloads += asset.get('download_count', 0)
                
                page += 1
            
            return total_downloads

        def update_readme(total_downloads_diablo4companion, total_downloads_newworldcompanion, total_downloads_liveappsoverlay):
            with open('README.md', 'r') as file:
                content = file.readlines()
            
            badge_url_diablo4companion = f"https://img.shields.io/badge/Downloads%20(Total)-{total_downloads_diablo4companion}-blue"
            badge_url_newworldcompanion = f"https://img.shields.io/badge/Downloads%20(Total)-{total_downloads_newworldcompanion}-blue"
            badge_url_liveappsoverlay = f"https://img.shields.io/badge/Downloads%20(Total)-{total_downloads_liveappsoverlay}-blue"
            new_badge_diablo4companion = f"![GitHub downloads Diablo4Companion]({badge_url_diablo4companion})"
            new_badge_newworldcompanion = f"![GitHub downloads NewWorldCompanion]({badge_url_newworldcompanion})"
            new_badge_liveappsoverlay = f"![GitHub downloads LiveAppsOverlay]({badge_url_liveappsoverlay})"
            
            # Find the position to insert or update the downloads badge
            downloads_badge_index_diablo4companion = next((i for i, line in enumerate(content) if '![GitHub downloads Diablo4Companion]' in line), -1)
            downloads_badge_index_newworldcompanion = next((i for i, line in enumerate(content) if '![GitHub downloads NewWorldCompanion]' in line), -1)
            downloads_badge_index_liveappsoverlay = next((i for i, line in enumerate(content) if '![GitHub downloads LiveAppsOverlay]' in line), -1)
            
            if downloads_badge_index_diablo4companion != -1:
                # Update existing downloads badge
                content[downloads_badge_index_diablo4companion] = new_badge_diablo4companion + '\n'
                
            if downloads_badge_index_newworldcompanion != -1:
                # Update existing downloads badge
                content[downloads_badge_index_newworldcompanion] = new_badge_newworldcompanion + '\n'

            if downloads_badge_index_liveappsoverlay != -1:
                # Update existing downloads badge
                content[downloads_badge_index_liveappsoverlay] = new_badge_liveappsoverlay + '\n'                
            
            with open('README.md', 'w') as file:
                file.writelines(content)

        total_downloads_diablo4companion = get_total_downloads("Diablo4Companion")
        total_downloads_newworldcompanion = get_total_downloads("NewWorldCompanion")
        total_downloads_liveappsoverlay = get_total_downloads("LiveAppsOverlay")
        update_readme(total_downloads_diablo4companion, total_downloads_newworldcompanion, total_downloads_liveappsoverlay)
        print(f"Total downloads (Diablo4Companion): {total_downloads_diablo4companion}")
        print(f"Total downloads (NewWorldCompanion): {total_downloads_newworldcompanion}")
        print(f"Total downloads (LiveAppsOverlay): {total_downloads_liveappsoverlay}")
      shell: python

    - name: Commit and push if changed
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git add README.md
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Update download count badge"
          git pull --rebase origin main
          git push
        fi
